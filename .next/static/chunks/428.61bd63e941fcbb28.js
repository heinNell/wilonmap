(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[428],{6428:(e,n,t)=>{"use strict";t.r(n),t.d(n,{default:()=>E});var l=t(8045),r=t(5177);let o=(0,r.createContext)(null);function a(){let e=(0,r.use)(o);if(null==e)throw Error("No context provided: useLeafletContext() can only be used in a descendant of <MapContainer>");return e}var i=t(2230),u=t.n(i);let s=(0,r.forwardRef)(function({bounds:e,boundsOptions:n,center:t,children:l,className:a,id:u,placeholder:s,style:c,whenReady:d,zoom:p,...f},m){let[x]=(0,r.useState)({className:a,id:u,style:c}),[v,h]=(0,r.useState)(null),g=(0,r.useRef)(void 0);(0,r.useImperativeHandle)(m,()=>v?.map??null,[v]);let b=(0,r.useCallback)(l=>{if(null!==l&&!g.current){let r=new i.Map(l,f);g.current=r,null!=t&&null!=p?r.setView(t,p):null!=e&&r.fitBounds(e,n),null!=d&&r.whenReady(d),h(Object.freeze({__version:1,map:r}))}},[]);(0,r.useEffect)(()=>()=>{v?.map.remove()},[v]);let j=v?r.createElement(o,{value:v},l):s??null;return r.createElement("div",{...x,ref:b},j)});var c=t(4380);function d(e,n){let t=(0,r.useRef)(n);(0,r.useEffect)(function(){n!==t.current&&null!=e.attributionControl&&(null!=t.current&&e.attributionControl.removeAttribution(t.current),null!=n&&e.attributionControl.addAttribution(n)),t.current=n},[e,n])}function p(e,n){let t=(0,r.useRef)(void 0);(0,r.useEffect)(function(){return null!=n&&e.instance.on(n),t.current=n,function(){null!=t.current&&e.instance.off(t.current),t.current=null}},[e,n])}function f(e,n){let t=e.pane??n.pane;return t?{...e,pane:t}:e}function m(e,n,t){return Object.freeze({instance:e,context:n,container:t})}function x(e,n){return null==n?function(n,t){let l=(0,r.useRef)(void 0);return l.current||(l.current=e(n,t)),l}:function(t,l){let o=(0,r.useRef)(void 0);o.current||(o.current=e(t,l));let a=(0,r.useRef)(t),{instance:i}=o.current;return(0,r.useEffect)(function(){a.current!==t&&(n(i,t,a.current),a.current=t)},[i,t,n]),o}}function v(e){return function(n){var t;let l=a(),o=e(f(n,l),l);return d(l.map,n.attribution),p(o.current,n.eventHandlers),t=o.current,(0,r.useEffect)(function(){return(l.layerContainer??l.map).addLayer(t.instance),function(){l.layerContainer?.removeLayer(t.instance),l.map.removeLayer(t.instance)}},[l,t]),o}}function h(e,n){var t,l;return t=x(e),l=function(e,l){let r=a(),o=t(f(e,r),r);return d(r.map,e.attribution),p(o.current,e.eventHandlers),n(o.current,r,e,l),o},(0,r.forwardRef)(function(e,n){let[t,o]=(0,r.useState)(!1),{instance:a}=l(e,o).current;(0,r.useImperativeHandle)(n,()=>a),(0,r.useEffect)(function(){t&&a.update()},[a,t,e.children]);let i=a._contentNode;return i?(0,c.createPortal)(e.children,i):null})}let g=function(e,n){var t;return t=v(x(e,n)),(0,r.forwardRef)(function(e,n){let{instance:l}=t(e).current;return(0,r.useImperativeHandle)(n,()=>l),null})}(function({url:e,...n},t){return m(new i.TileLayer(e,f(n,t)),t)},function(e,n,t){let{opacity:l,zIndex:r}=n;null!=l&&l!==t.opacity&&e.setOpacity(l),null!=r&&r!==t.zIndex&&e.setZIndex(r);let{url:o}=n;null!=o&&o!==t.url&&e.setUrl(o)}),b=function(e,n){var t;return t=v(x(e,n)),(0,r.forwardRef)(function(e,n){let{instance:l,context:a}=t(e).current;(0,r.useImperativeHandle)(n,()=>l);let{children:i}=e;return null==i?null:r.createElement(o,{value:a},i)})}(function({position:e,...n},t){var l;let r=new i.Marker(e,n);return m(r,(l={overlayContainer:r},Object.freeze({...t,...l})))},function(e,n,t){n.position!==t.position&&e.setLatLng(n.position),null!=n.icon&&n.icon!==t.icon&&e.setIcon(n.icon),null!=n.zIndexOffset&&n.zIndexOffset!==t.zIndexOffset&&e.setZIndexOffset(n.zIndexOffset),null!=n.opacity&&n.opacity!==t.opacity&&e.setOpacity(n.opacity),null!=e.dragging&&n.draggable!==t.draggable&&(!0===n.draggable?e.dragging.enable():e.dragging.disable())}),j=h(function(e,n){return m(new i.Tooltip(e,n.overlayContainer),n)},function(e,n,{position:t},l){(0,r.useEffect)(function(){let r=n.overlayContainer;if(null==r)return;let{instance:o}=e,a=e=>{e.tooltip===o&&(null!=t&&o.setLatLng(t),o.update(),l(!0))},i=e=>{e.tooltip===o&&l(!1)};return r.on({tooltipopen:a,tooltipclose:i}),r.bindTooltip(o),function(){r.off({tooltipopen:a,tooltipclose:i}),null!=r._map&&r.unbindTooltip()}},[e,n,l,t])}),y=h(function(e,n){return m(new i.Popup(e,n.overlayContainer),n)},function(e,n,{position:t},l){(0,r.useEffect)(function(){let{instance:r}=e;function o(e){e.popup===r&&(r.update(),l(!0))}function a(e){e.popup===r&&l(!1)}return n.map.on({popupopen:o,popupclose:a}),null==n.overlayContainer?(null!=t&&r.setLatLng(t),r.openOn(n.map)):n.overlayContainer.bindPopup(r),function(){n.map.off({popupopen:o,popupclose:a}),n.overlayContainer?.unbindPopup(),n.map.removeLayer(r)}},[e,n,l,t])});var w=t(8450),N=t(1312),C=t(6287);t(9512);let k=u().icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconAnchor:[12,41]});function L(e){let{coords:n}=e,t=a().map,l=(0,r.useRef)(!1);return(0,r.useEffect)(()=>{if(l.current||0===n.length)return;let e=u().latLngBounds(n.map(e=>{let[n,t]=e;return u().latLng(n,t)}));t.fitBounds(e.pad(.15)),l.current=!0},[n,t]),null}function E(e){let{initialIntervalMs:n=1e4}=e,[t,o]=(0,r.useState)(null),[a,i]=(0,r.useState)(null),[u,c]=(0,r.useState)(()=>Date.now()),[d,p]=(0,r.useState)(n),f=async()=>{try{let e=await (0,w.V)("/api/wialon?action=positionsNow");o(e),i(null),c(Date.now())}catch(e){i(e.message||String(e))}};(0,r.useEffect)(()=>{f()},[]),(0,r.useEffect)(()=>{let e=setInterval(f,d);return()=>clearInterval(e)},[d]);let m=Array.isArray(null==t?void 0:t.items)?t.items:[],x=(0,r.useMemo)(()=>m.map(e=>{var n,t,l,r,o,a,i,u,s,c,d;let p=(null==e?void 0:e.pos)||(null==e||null==(n=e.lmsg)?void 0:n.pos),f=null==p?void 0:p.y,m=null==p?void 0:p.x;return"number"!=typeof f||"number"!=typeof m?null:{id:null==e?void 0:e.id,name:null!=(i=null!=(a=null==e?void 0:e.nm)?a:null==e?void 0:e.name)?i:String(null==e?void 0:e.id),lat:f,lon:m,speed:null!=(u=null==p?void 0:p.s)?u:0,heading:null!=(s=null==p?void 0:p.c)?s:null,fuelA:null!=(c=null==e||null==(l=e.lmsg)||null==(t=l.p)?void 0:t.io_270)?c:null,fuelB:null!=(d=null==e||null==(o=e.lmsg)||null==(r=o.p)?void 0:r.io_273)?d:null}}).filter(Boolean),[m]),v=x.length?[x[0].lat,x[0].lon]:[-24,28],h=x.length>0?x.map(e=>[e.lat,e.lon]):void 0;return(0,l.jsxs)(N.A,{title:"Fleet map",toolbar:(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsxs)("select",{className:"text-sm border border-slate-200 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200",value:d,onChange:e=>p(Number(e.target.value)),title:"Refresh interval",children:[(0,l.jsx)("option",{value:5e3,children:"5s"}),(0,l.jsx)("option",{value:1e4,children:"10s"}),(0,l.jsx)("option",{value:3e4,children:"30s"}),(0,l.jsx)("option",{value:6e4,children:"60s"})]}),(0,l.jsx)("button",{className:"text-sm text-primary-600 hover:text-primary-700 font-medium underline underline-offset-2 transition-colors duration-200",onClick:f,children:"Refresh"}),(0,l.jsxs)("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[(0,l.jsx)("div",{className:"h-2 w-2 bg-success-500 rounded-full animate-pulse"}),(0,l.jsxs)("span",{children:["Updated"," ",new Date(u).toLocaleTimeString("en-ZA",{timeZone:"Africa/Johannesburg"})]})]})]}),children:[a&&(0,l.jsx)(C.A,{message:a}),(0,l.jsx)("div",{className:"h-[520px] w-full border border-slate-200 rounded-xl overflow-hidden shadow-inner bg-slate-50",children:(0,l.jsxs)(s,{center:v,zoom:6,scrollWheelZoom:!0,style:{height:"100%",width:"100%"},children:[(0,l.jsx)(g,{attribution:'\xa9 <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),h&&(0,l.jsx)(L,{coords:h}),x.map(e=>{var n,t;return(0,l.jsxs)(b,{position:[e.lat,e.lon],children:[(0,l.jsx)(j,{children:e.name}),(0,l.jsx)(y,{children:(0,l.jsxs)("div",{className:"text-sm space-y-3 min-w-[250px]",children:[(0,l.jsx)("div",{className:"font-semibold text-slate-800 text-base border-b border-slate-200 pb-2",children:e.name}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"Coordinates:"}),(0,l.jsxs)("span",{className:"font-mono text-xs",children:[e.lat.toFixed(6),", ",e.lon.toFixed(6)]})]}),(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"Speed:"}),(0,l.jsxs)("span",{className:"font-semibold",children:[e.speed," km/h"]})]}),null!=e.heading&&(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"Heading:"}),(0,l.jsxs)("span",{children:[e.heading,"\xb0"]})]}),(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"Fuel A/B:"}),(0,l.jsxs)("span",{children:[null!=(n=e.fuelA)?n:"—"," / ",null!=(t=e.fuelB)?t:"—"]})]})]}),(0,l.jsxs)("a",{className:"inline-flex items-center gap-1 text-primary-600 hover:text-primary-700 underline underline-offset-2 text-xs font-medium",target:"_blank",rel:"noreferrer",href:"https://www.openstreetmap.org/?mlat=".concat(e.lat,"&mlon=").concat(e.lon,"#map=12/").concat(e.lat,"/").concat(e.lon),children:[(0,l.jsx)("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})}),"Open in OpenStreetMap"]})]})})]},e.id)})]})})]})}u().Marker.prototype.options.icon=k},9512:()=>{}}]);